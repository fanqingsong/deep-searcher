# Milvus 图文搜索完整实现教程

## 🎯 项目概览

本教程展示如何使用 Milvus 向量数据库构建一个完整的图文搜索系统，支持：
- 文本搜索图像
- 图像搜索文本  
- 图像搜索相似图像
- 条件过滤搜索

## 📋 环境配置

### 1. 启动 Milvus 服务
```bash
# 使用 docker-compose 启动
docker-compose up -d

# 验证服务状态
docker ps | grep milvus
```

### 2. 安装 Python 依赖
```bash
pip install pymilvus numpy
# 生产环境还需要：
pip install transformers torch pillow requests
```

## 🔧 核心实现步骤

### 第一步：连接数据库
```python
from pymilvus import MilvusClient
client = MilvusClient("http://localhost:19530")
```

### 第二步：创建集合
```python
collection_name = "multimodal_search"

# 删除已存在的集合（如有）
if client.has_collection(collection_name):
    client.drop_collection(collection_name)

# 创建新集合
client.create_collection(
    collection_name=collection_name,
    dimension=384,  # 向量维度
    metric_type="COSINE",  # 余弦相似度
    consistency_level="Strong"  # 强一致性
)
```

### 第三步：向量化数据
```python
import hashlib
import numpy as np

def text_to_vector(text, dim=384):
    """将文本转换为向量（模拟 CLIP 编码器）"""
    # 使用哈希确保同样文本产生同样向量
    hash_obj = hashlib.md5(text.encode())
    seed = int(hash_obj.hexdigest()[:8], 16)
    np.random.seed(seed)
    
    # 生成并归一化向量
    vector = np.random.random(dim)
    vector = vector / np.linalg.norm(vector)
    return vector.tolist()

# 实际生产中使用 CLIP 模型：
# from transformers import CLIPProcessor, CLIPModel
# model = CLIPModel.from_pretrained("openai/clip-vit-base-patch32")
# processor = CLIPProcessor.from_pretrained("openai/clip-vit-base-patch32")
```

### 第四步：插入数据
```python
# 准备多模态数据
data = [
    {
        "id": 1, 
        "image_path": "cat_01.jpg",
        "description": "可爱的橙色小猫在阳光下玩耍",
        "category": "动物",
        "vector": text_to_vector("可爱的橙色小猫在阳光下玩耍")
    },
    {
        "id": 2,
        "image_path": "dog_02.jpg", 
        "description": "金毛犬在草地上奔跑",
        "category": "动物",
        "vector": text_to_vector("金毛犬在草地上奔跑")
    },
    # ... 更多数据
]

# 批量插入
client.insert(collection_name, data)

# 等待数据处理完成
import time
time.sleep(2)
```

### 第五步：实现搜索功能

#### 文本搜索图像
```python
def search_images_by_text(query_text, top_k=5):
    """使用文本搜索相关图像"""
    # 将查询文本转换为向量
    query_vector = text_to_vector(query_text)
    
    # 执行向量搜索
    results = client.search(
        collection_name=collection_name,
        data=[query_vector],
        limit=top_k,
        output_fields=["image_path", "description", "category"]
    )
    
    return results[0] if results else []

# 使用示例
results = search_images_by_text("可爱的小动物")
for result in results:
    similarity = 1 - result['distance']
    print(f"相似度: {similarity:.3f}")
    print(f"图片: {result['entity']['image_path']}")
    print(f"描述: {result['entity']['description']}")
```

#### 条件过滤搜索
```python
def search_with_filter(query_text, category_filter, top_k=5):
    """带条件过滤的搜索"""
    query_vector = text_to_vector(query_text)
    
    results = client.search(
        collection_name=collection_name,
        data=[query_vector],
        limit=top_k,
        filter=f'category == "{category_filter}"',  # 添加过滤条件
        output_fields=["image_path", "description", "category"]
    )
    
    return results[0] if results else []

# 只搜索动物类别
animal_results = search_with_filter("毛茸茸的", "动物")
```

## 🚀 运行演示

我们提供了几个示例文件：

### 1. 基础示例
```bash
python3 simple_example.py
```
展示基本的向量搜索原理和操作。

### 2. 搜索演示  
```bash
python3 demo_search.py
```
演示文本到文本的相似性搜索。

## 📊 实际应用场景

### 1. 电商平台
```python
# 用户上传图片搜索相似商品
user_image = "user_upload.jpg"
similar_products = search_images_by_image(user_image, top_k=10)

# 用户输入描述搜索商品
query = "红色连衣裙"
products = search_images_by_text(query, top_k=10)
```

### 2. 内容管理系统
```python
# 编辑根据文章内容搜索配图
article_content = "科技创新改变生活"
relevant_images = search_images_by_text(article_content, top_k=5)

# 根据现有图片找相似素材
reference_image = "tech_innovation.jpg"
similar_images = search_images_by_image(reference_image, top_k=8)
```

### 3. 智能相册
```python
# 语义搜索个人照片
search_results = search_images_by_text("生日聚会")
search_results = search_images_by_text("海边度假")
search_results = search_images_by_text("宠物照片")
```

## 🎛️ 性能优化

### 1. 索引优化
```python
# 创建高性能索引
index_params = {
    "index_type": "HNSW",
    "metric_type": "COSINE", 
    "params": {"M": 16, "efConstruction": 200}
}

client.create_index(
    collection_name=collection_name,
    field_name="vector",
    index_params=index_params
)
```

### 2. 批量处理
```python
# 批量插入优化
batch_size = 1000
for i in range(0, len(large_dataset), batch_size):
    batch = large_dataset[i:i + batch_size]
    client.insert(collection_name, batch)
    
    # 定期刷新
    if i % (batch_size * 10) == 0:
        client.flush(collection_name)
```

### 3. 内存管理
```python
# 加载集合到内存以提升搜索速度
client.load_collection(collection_name)

# 不使用时释放内存
client.release_collection(collection_name)
```

## 📈 扩展功能

### 1. 混合搜索
```python
def hybrid_search(text_query, image_query=None, weights=[0.7, 0.3]):
    """结合文本和图像的混合搜索"""
    text_results = search_images_by_text(text_query, top_k=20)
    
    if image_query:
        image_results = search_images_by_image(image_query, top_k=20)
        # 实现结果融合逻辑
        return merge_results(text_results, image_results, weights)
    else:
        return text_results[:10]
```

### 2. 实时更新
```python
def update_data(item_id, new_description, new_image_path):
    """实时更新数据"""
    # 删除旧数据
    client.delete(collection_name, expr=f"id == {item_id}")
    
    # 插入新数据
    new_vector = text_to_vector(new_description)
    new_data = [{
        "id": item_id,
        "image_path": new_image_path,
        "description": new_description,
        "vector": new_vector
    }]
    client.insert(collection_name, new_data)
```

## 🔍 故障排除

### 常见问题及解决方案

1. **连接失败**
   ```bash
   # 检查服务状态
   docker ps | grep milvus
   # 重启服务
   docker-compose restart
   ```

2. **搜索无结果**
   ```python
   # 确保数据已插入
   client.flush(collection_name)
   # 检查集合状态
   client.get_collection_stats(collection_name)
   ```

3. **性能较慢**
   ```python
   # 检查是否已创建索引
   client.list_indexes(collection_name)
   # 检查集合是否已加载
   client.get_load_state(collection_name)
   ```

## 💡 最佳实践

1. **向量质量**: 使用高质量的预训练模型（CLIP, BERT等）
2. **数据预处理**: 清洗和标准化输入数据
3. **索引选择**: 根据数据规模选择合适的索引类型
4. **批量操作**: 大数据量时使用批量插入和搜索
5. **监控维护**: 定期监控性能和存储使用情况

## 🔗 参考资源

- [Milvus 官方文档](https://milvus.io/docs)
- [CLIP 模型介绍](https://github.com/openai/CLIP)
- [PyMilvus API 参考](https://milvus.io/api-reference/pymilvus)
- [向量数据库最佳实践](https://zilliz.com/learn)

---

通过本教程，您已经掌握了使用 Milvus 构建图文搜索系统的完整流程。现在可以根据实际需求扩展和优化您的多模态搜索应用！
